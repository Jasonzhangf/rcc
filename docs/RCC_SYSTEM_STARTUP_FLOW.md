# RCC 系统启动流程图

## 1. 系统架构概览

```
┌─────────────────────────────────────────────────────────────────┐
│                    RCC 完整系统架构                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────┐ │
│  │   RCC CLI      │    │   Web UI        │    │   API       │ │
│  │   入口点        │    │   配置界面       │    │   接口       │ │
│  └─────────────────┘    └─────────────────┘    └─────────────┘ │
│           │                       │                     │        │
│           └───────────────────────┼─────────────────────┘        │
│                                   │                              │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                 核心启动系统                                │ │
│  │            start-rcc-system.mjs                             │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                                   │                              │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                 模块发现与加载                              │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                                   │                              │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────┐ │
│  │ Configuration  │    │   Pipeline      │    │   Server    │ │
│  │    模块        │    │    模块         │    │   模块       │ │
│  └─────────────────┘    └─────────────────┘    └─────────────┘ │
│           │                       │                     │        │
│           └───────────────────────┼─────────────────────┘        │
│                                   │                              │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                 虚拟模型路由系统                            │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                                   │                              │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────┐ │
│  │   Qwen         │    │   LMStudio      │    │   iFlow     │ │
│  │  Provider       │    │   Provider      │    │  Provider   │ │
│  └─────────────────┘    └─────────────────┘    └─────────────┘ │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## 2. 详细启动流程

### 2.1 初始启动阶段

```mermaid
graph TD
    A[用户启动命令] --> B{启动方式}
    B -->|CLI模式| C[rcc4 start]
    B -->|直接启动| D[node start-rcc-system.mjs]
    B -->|Web UI模式| E[启动配置界面]

    C --> F[加载配置文件]
    D --> F
    E --> F

    F --> G[解析命令行参数]
    G --> H[设置环境变量]
    H --> I[初始化调试系统]
    I --> J[创建系统实例]
```

### 2.2 系统初始化流程

```mermaid
graph TD
    J[创建系统实例] --> K[模块发现系统]
    K --> L[扫描sharedmodule目录]
    L --> M[识别可用模块]
    M --> N{模块验证}

    N -->|验证通过| O[加载模块配置]
    N -->|验证失败| P[记录错误并跳过]

    O --> Q[依赖关系解析]
    Q --> R[建立模块依赖图]
    R --> S[按顺序初始化模块]

    S --> T[Configuration模块]
    T --> U[Pipeline模块]
    U --> V[Server模块]
    V --> W[Provider模块]
```

### 2.3 Configuration模块启动流程

```mermaid
graph TD
    T[Configuration模块] --> T1[加载默认配置]
    T1 --> T2[读取用户配置文件]
    T2 --> T3[合并配置层次]
    T3 --> T4[环境变量替换]
    T4 --> T5[配置验证]
    T5 --> T6[启动Web UI服务]
    T6 --> T7[初始化文件监控]
    T7 --> T8[配置完成事件]
```

### 2.4 Pipeline模块启动流程

```mermaid
graph TD
    U[Pipeline模块] --> U1[初始化PipelineFactory]
    U1 --> U2[创建PipelineTracker]
    U2 --> U3[初始化DebugLogManager]
    U3 --> U4[加载Provider配置]
    U4 --> U5[创建虚拟模型配置]
    U5 --> U6[建立Pipeline实例]
    U6 --> U7[启动健康检查]
    U7 --> U8[Pipeline就绪]
```

### 2.5 Server模块启动流程

```mermaid
graph TD
    V[Server模块] --> V1[创建HTTP服务器]
    V1 --> V2[配置中间件]
    V2 --> V3[设置路由规则]
    V3 --> V4[初始化虚拟模型路由]
    V4 --> V5[加载路由规则]
    V5 --> V6[启动服务器监听]
    V6 --> V7[服务器运行中]
```

### 2.6 Provider模块启动流程

```mermaid
graph TD
    W[Provider模块] --> W1{Provider类型}
    W1 -->|Qwen| W2[初始化QwenProvider]
    W1 -->|LMStudio| W3[初始化LMStudioProvider]
    W1 -->|iFlow| W4[初始化iFlowProvider]

    W2 --> W5[加载认证凭据]
    W3 --> W5
    W4 --> W5

    W5 --> W6[配置API端点]
    W6 --> W7[测试连接]
    W7 --> W8[健康检查]
    W8 --> W9[Provider就绪]
```

## 3. 运行时处理流程

### 3.1 请求处理流程

```mermaid
graph TD
    A[客户端请求] --> B[HTTP服务器接收]
    B --> C[路由匹配]
    C --> D{虚拟模型路由}

    D -->|匹配规则| E[选择目标Provider]
    D -->|默认路由| F[使用默认Provider]

    E --> G[Pipeline调度]
    F --> G

    G --> H[负载均衡]
    H --> I[Provider执行]
    I --> J[响应处理]
    J --> K[返回客户端]
```

### 3.2 错误处理流程

```mermaid
graph TD
    A[错误发生] --> B{错误类型}
    B -->|Provider错误| C[切换备用Provider]
    B -->|配置错误| D[使用默认配置]
    B -->|系统错误| E[记录错误日志]

    C --> F[重试请求]
    D --> G[继续处理]
    E --> H[返回错误响应]

    F --> I{重试成功}
    I -->|成功| J[正常处理]
    I -->|失败| K[降级处理]

    G --> J
    H --> L[结束]
    J --> K
    K --> L
```

## 4. 配置和管理流程

### 4.1 动态配置更新

```mermaid
graph TD
    A[配置文件变更] --> B[文件监控检测]
    B --> C[配置重新加载]
    C --> D[配置验证]
    D --> E{验证结果}

    E -->|成功| F[应用新配置]
    E -->|失败| G[回滚到旧配置]

    F --> H[通知相关模块]
    G --> I[记录错误]

    H --> J[更新完成]
    I --> J
```

### 4.2 模块生命周期管理

```mermaid
graph TD
    A[模块启动] --> B[初始化阶段]
    B --> C[配置加载]
    C --> D[依赖检查]
    D --> E[服务注册]
    E --> F[健康检查]
    F --> G[运行中]

    G --> H{监控状态}
    H -->|正常| I[继续运行]
    H -->|异常| J[错误恢复]

    J --> K{恢复成功}
    K -->|成功| I
    K -->|失败| L[模块重启]

    I --> M[模块停止]
    L --> B
    M --> N[资源清理]
    N --> O[完成]
```

## 5. 系统监控和日志

### 5.1 调试日志系统

```mermaid
graph TD
    A[日志事件] --> B{日志级别}
    B -->|DEBUG| C[开发调试]
    B -->|INFO| D[系统信息]
    B -->|WARN| E[警告信息]
    B -->|ERROR| F[错误信息]

    C --> G[写入调试日志]
    D --> H[写入系统日志]
    E --> I[写入警告日志]
    F --> J[写入错误日志]

    G --> K[日志文件管理]
    H --> K
    I --> K
    J --> K

    K --> L[日志轮转]
    L --> M[日志压缩]
    M --> N[日志清理]
```

### 5.2 性能监控

```mermaid
graph TD
    A[性能指标收集] --> B[请求计数]
    A --> C[响应时间]
    A --> D[错误率]
    A --> E[资源使用]

    B --> F[性能统计]
    C --> F
    D --> F
    E --> F

    F --> G[生成报告]
    G --> H[性能分析]
    H --> I[优化建议]
    I --> J[报告输出]
```

## 6. 启动命令示例

### 6.1 基本启动命令

```bash
# 1. 使用默认配置启动
./rcc4 start

# 2. 指定配置文件启动
./rcc4 start --config /path/to/config.json

# 3. 指定端口启动
./rcc4 start --port 5507

# 4. 调试模式启动
DEBUG=true ./rcc4 start

# 5. 直接使用Node.js启动
node start-rcc-system.mjs
```

### 6.2 配置示例

```json
{
  "server": {
    "port": 5507,
    "host": "localhost"
  },
  "providers": {
    "qwen": {
      "enabled": true,
      "apiKey": "your-api-key",
      "endpoint": "https://api.qwen.com"
    },
    "lmstudio": {
      "enabled": true,
      "endpoint": "http://localhost:1234"
    }
  },
  "virtualModels": [
    {
      "id": "default",
      "name": "Default Model",
      "provider": "qwen",
      "modelId": "qwen-turbo"
    }
  ]
}
```

## 7. 系统检查清单

### 7.1 启动前检查

- [ ] 确保Node.js版本 >= 14.0.0
- [ ] 检查依赖模块已安装
- [ ] 验证配置文件存在且有效
- [ ] 确保端口未被占用
- [ ] 检查网络连接

### 7.2 启动后验证

- [ ] 系统进程正常运行
- [ ] HTTP服务响应正常
- [ ] Provider连接成功
- [ ] 日志系统正常工作
- [ ] Web UI可访问

### 7.3 功能测试

- [ ] 基本请求处理
- [ ] 虚拟模型路由
- [ ] 错误处理机制
- [ ] 配置动态更新
- [ ] 性能指标收集

这个流程图涵盖了RCC系统从启动到运行的完整生命周期，包括各个模块的初始化、配置管理、请求处理和监控等方面。