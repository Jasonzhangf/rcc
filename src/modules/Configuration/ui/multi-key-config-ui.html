<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Key Configuration Manager</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #2c2c2c 0%, #1a1a1a 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: #f8f9fa;
            border-radius: 12px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #333333 0%, #1a1a1a 100%);
            color: #ffffff;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .main-content {
            padding: 30px;
        }

        .section-tabs {
            display: flex;
            border-bottom: 2px solid #cccccc;
            margin-bottom: 30px;
        }

        .tab-button {
            padding: 12px 24px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            color: #666666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .tab-button.active {
            color: #000000;
            border-bottom-color: #000000;
        }

        .tab-button:hover {
            color: #000000;
            background: #e6e6e6;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 1.8em;
            font-weight: 600;
            color: #000000;
        }

        .section-actions {
            display: flex;
            gap: 10px;
        }

        .provider-list {
            display: grid;
            gap: 20px;
            margin-bottom: 30px;
        }

        .provider-card {
            border: 2px solid #cccccc;
            border-radius: 12px;
            padding: 25px;
            transition: all 0.3s ease;
            background: #ffffff;
        }

        .provider-card:hover {
            border-color: #666666;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .provider-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .provider-name {
            font-size: 1.4em;
            font-weight: 600;
            color: #000000;
        }

        .provider-info {
            font-size: 0.9em;
            color: #666666;
        }

        .auth-type-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
            text-transform: uppercase;
        }

        .auth-api-key {
            background: #e6e6e6;
            color: #000000;
        }

        .auth-oauth {
            background: #f0f0f0;
            color: #333333;
        }

        .keys-section {
            margin: 15px 0;
        }

        .keys-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .keys-title {
            font-weight: 600;
            color: #000000;
        }

        .keys-count {
            background: #333333;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .key-list {
            display: grid;
            gap: 10px;
        }

        .key-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 15px;
            background: #ffffff;
            border: 1px solid #cccccc;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .key-item:hover {
            border-color: #666666;
            background: #f0f0f0;
        }

        .key-info {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .key-index {
            background: #333333;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8em;
            font-weight: 600;
        }

        .key-value {
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.9em;
            color: #000000;
            background: #f0f0f0;
            padding: 4px 8px;
            border-radius: 4px;
            flex: 1;
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .key-type {
            font-size: 0.8em;
            color: #666666;
            padding: 2px 6px;
            background: #e6e6e6;
            border-radius: 4px;
        }

        .key-actions {
            display: flex;
            gap: 8px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 0.9em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary {
            background: #333333;
            color: white;
        }

        .btn-primary:hover {
            background: #1a1a1a;
        }

        .btn-secondary {
            background: #cccccc;
            color: #000000;
        }

        .btn-secondary:hover {
            background: #b3b3b3;
        }

        .btn-danger {
            background: #666666;
            color: white;
        }

        .btn-danger:hover {
            background: #4d4d4d;
        }

        .btn-success {
            background: #333333;
            color: white;
        }

        .btn-success:hover {
            background: #1a1a1a;
        }

        .btn-small {
            padding: 4px 8px;
            font-size: 0.8em;
        }

        .provider-actions {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: #ffffff;
            border-radius: 12px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 1.5em;
            font-weight: 600;
            color: #000000;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #000000;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #cccccc;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.2s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #666666;
        }

        .form-select {
            width: 100%;
            padding: 12px;
            border: 2px solid #cccccc;
            border-radius: 8px;
            font-size: 1em;
            background: #ffffff;
            cursor: pointer;
        }

        .form-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-checkbox input {
            transform: scale(1.2);
        }

        /* Router Table Styles */
        .router-table {
            background: #ffffff;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid #cccccc;
        }

        .router-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .router-table th,
        .router-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #cccccc;
        }

        .router-table th {
            background: #f0f0f0;
            font-weight: 600;
            color: #000000;
            font-size: 0.9em;
        }

        .router-table td {
            color: #666666;
            font-size: 0.9em;
        }

        .router-table tr:hover {
            background: #f0f0f0;
        }

        .router-table .priority-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
            text-align: center;
            min-width: 30px;
        }

        .priority-high {
            background: #e6e6e6;
            color: #000000;
        }

        .priority-medium {
            background: #f0f0f0;
            color: #333333;
        }

        .priority-low {
            background: #f8f8f8;
            color: #666666;
        }

        .pattern-code {
            font-family: 'Monaco', 'Menlo', monospace;
            background: #f0f0f0;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.8em;
        }

        /* Provider Card Enhancements */
        .provider-card .protocol-type {
            font-size: 0.8em;
            color: #666666;
            margin-top: 5px;
        }

        .provider-edit-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        /* Configuration Section */
        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .config-card {
            background: #ffffff;
            border: 2px solid #cccccc;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .config-card:hover {
            border-color: #666666;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .config-card-title {
            font-size: 1.2em;
            font-weight: 600;
            color: #14171a;
            margin-bottom: 10px;
        }

        .config-card-content {
            color: #657786;
            font-size: 0.9em;
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 30px;
        }

        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-active {
            background: #17bf63;
        }

        .status-inactive {
            background: #657786;
        }

        .status-error {
            background: #e0245e;
        }

        .test-result {
            margin-top: 15px;
            padding: 12px;
            border-radius: 8px;
            font-size: 0.9em;
        }

        .test-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .test-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .rotation-demo {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .rotation-step {
            padding: 8px;
            margin: 4px 0;
            background: white;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.9em;
        }

        /* Models Modal Styles */
        .models-result {
            margin: 0;
        }

        .models-result h4 {
            margin-bottom: 15px;
            color: #14171a;
            font-size: 1.3em;
        }

        .models-list {
            border: 1px solid #e1e8ed;
            border-radius: 8px;
            padding: 10px;
            background: #fafbfc;
        }

        .model-item {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            margin: 4px 0;
            background: white;
            border-radius: 6px;
            border: 1px solid #e1e8ed;
            transition: all 0.2s ease;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.9em;
        }

        .model-item:hover {
            border-color: #4facfe;
            background: #f8fbff;
        }

        .model-item strong {
            color: #667eea;
            margin-right: 8px;
        }

        /* Enhanced Provider Actions */
        .provider-actions .btn {
            margin: 4px;
        }

        .provider-models-info {
            margin-top: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 4px solid #4facfe;
        }

        .provider-models-info h5 {
            margin: 0 0 8px 0;
            color: #14171a;
            font-size: 0.9em;
            font-weight: 600;
        }

        .provider-models-list {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin: 0;
        }

        .model-tag {
            background: #e8f4fd;
            color: #1da1f2;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 500;
        }

        /* Model Management Styles */
        .model-section {
            margin-bottom: 30px;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            background: #fafafa;
            overflow: hidden;
        }

        .model-section-header {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px 20px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-bottom: 1px solid #dee2e6;
        }

        .model-section-header.clickable {
            cursor: pointer;
            transition: background 0.2s;
        }

        .model-section-header.clickable:hover {
            background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
        }

        .model-section-title {
            margin: 0;
            font-size: 1.1em;
            font-weight: 600;
            color: #495057;
        }

        .model-count {
            background: #007bff;
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 500;
            min-width: 24px;
            text-align: center;
        }

        .collapse-indicator {
            margin-left: auto;
            font-size: 1.2em;
            transition: transform 0.3s ease;
            color: #6c757d;
        }

        .model-section.collapsible .model-section-header.collapsed .collapse-indicator {
            transform: rotate(-90deg);
        }

        .models-container {
            margin-top: 0;
            padding: 0;
            background: white;
        }

        .models-container.collapsed {
            display: none;
        }

        .models-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .model-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .model-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
        }

        .model-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .model-name {
            margin: 0;
            color: #1da1f2;
            font-family: monospace;
            font-size: 1.1em;
        }

        .model-badges {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .status-badge, .protocol-badge {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 500;
            color: white;
            text-align: center;
        }

        .protocol-badge {
            background: #666;
        }

        .model-info {
            margin-bottom: 15px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.9em;
        }

        .info-row .label {
            font-weight: 500;
            color: #666;
        }

        .info-row .value {
            color: #333;
            font-family: monospace;
        }

        .model-actions {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .btn-sm {
            padding: 4px 8px;
            font-size: 0.8em;
            border-radius: 4px;
        }

        .no-models, .loading-message {
            text-align: center;
            padding: 40px;
            color: #666;
            font-style: italic;
        }

        /* Blacklist and Pool Modal Styles */
        .blacklist-items, .pool-items {
            max-height: 400px;
            overflow-y: auto;
        }

        .blacklist-item, .pool-item {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
        }

        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .item-header h4 {
            margin: 0;
            color: #333;
        }

        .provider-label {
            background: #e3f2fd;
            color: #1976d2;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 500;
        }

        .item-info {
            margin-bottom: 10px;
            font-size: 0.9em;
        }

        .item-info p {
            margin: 4px 0;
        }

        .item-actions {
            display: flex;
            gap: 8px;
        }

        .no-items {
            text-align: center;
            padding: 40px;
            color: #666;
            font-style: italic;
        }

        /* Router Table Enhancements */
        .router-table .btn-small {
            padding: 2px 6px;
            font-size: 0.75em;
        }

        .empty-router-state {
            text-align: center;
            padding: 40px 20px;
            color: #657786;
        }

        /* Virtual Routes Styles */
        .virtual-routes-container {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }

        .virtual-categories {
            flex: 2;
            background: white;
            border-radius: 12px;
            border: 1px solid #e1e8ed;
            padding: 20px;
        }

        .categories-header {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e1e8ed;
        }

        .available-models-sidebar {
            flex: 1;
            background: white;
            border-radius: 12px;
            border: 1px solid #e1e8ed;
            padding: 20px;
            max-height: 600px;
            overflow-y: auto;
        }

        .available-models-sidebar h3 {
            color: #14171a;
            margin-bottom: 15px;
            font-size: 1.2em;
            font-weight: 600;
        }

        .search-box {
            margin-bottom: 15px;
        }

        .search-box input {
            width: 100%;
            padding: 10px;
            border: 1px solid #e1e8ed;
            border-radius: 8px;
            font-size: 14px;
        }

        .virtual-category {
            background: #f8fbff;
            border: 1px solid #e1e8ed;
            border-radius: 12px;
            margin-bottom: 20px;
            padding: 20px;
        }

        .virtual-category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            cursor: pointer;
            border-bottom: 2px solid #e1e8ed;
            padding-bottom: 10px;
        }

        .virtual-category-title {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .virtual-category-name {
            font-size: 1.3em;
            font-weight: 600;
            color: #14171a;
        }

        .virtual-category-badge {
            background: #4facfe;
            color: white;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.8em;
            font-weight: 500;
        }

        .virtual-category-actions {
            display: flex;
            gap: 8px;
        }

        .virtual-category-content {
            display: none;
        }

        .virtual-category-content.expanded {
            display: block;
        }

        .virtual-category-routes {
            background: white;
            border-radius: 8px;
            border: 1px solid #e1e8ed;
            margin-bottom: 15px;
        }

        .route-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            border-bottom: 1px solid #e1e8ed;
        }

        .route-item:last-child {
            border-bottom: none;
        }

        .route-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .route-model {
            font-weight: 600;
            color: #14171a;
        }

        .route-provider {
            font-size: 0.9em;
            color: #657786;
        }

        .route-meta {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.8em;
            color: #657786;
        }

        .route-weight {
            background: #f0f2f5;
            padding: 2px 6px;
            border-radius: 4px;
        }

        .route-actions {
            display: flex;
            gap: 8px;
        }

        .available-model-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border: 1px solid #e1e8ed;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .available-model-item:hover {
            background: #f8fbff;
            border-color: #4facfe;
        }

        .available-model-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .available-model-name {
            font-weight: 600;
            color: #14171a;
            font-size: 0.9em;
        }

        .available-model-provider {
            font-size: 0.8em;
            color: #657786;
        }

        .load-balancing-config {
            background: #f0f8ff;
            border: 1px solid #b3d9ff;
            border-radius: 8px;
            padding: 15px;
        }

        .load-balancing-title {
            font-weight: 600;
            color: #14171a;
            margin-bottom: 10px;
        }

        .load-balancing-select {
            width: 100%;
            padding: 8px;
            border: 1px solid #e1e8ed;
            border-radius: 6px;
            font-size: 14px;
        }

        .empty-routes {
            text-align: center;
            padding: 30px;
            color: #657786;
            font-style: italic;
        }

        .add-route-section {
            text-align: center;
            padding: 15px;
            border-top: 2px dashed #e1e8ed;
            margin-top: 15px;
        }

        @media (max-width: 768px) {
            .provider-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .key-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .key-actions {
                align-self: stretch;
                justify-content: flex-end;
            }

            .provider-actions {
                justify-content: flex-start;
                flex-wrap: wrap;
            }

            .models-list {
                max-height: 200px !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🔑 Multi-Key Configuration Manager</h1>
            <p>Manage API keys, OAuth tokens, authentication settings, providers and routing rules</p>
        </div>

        <div class="main-content">
            <!-- Navigation Tabs -->
            <div class="section-tabs">
                <button class="tab-button active" onclick="switchTab('providers')">Providers</button>
                <button class="tab-button" onclick="switchTab('models')">Model Management</button>
                <button class="tab-button" onclick="switchTab('router')">Router Table</button>
                <button class="tab-button" onclick="switchTab('config')">Configuration</button>
            </div>

            <!-- Providers Tab -->
            <div class="tab-content active" id="providers-tab">
                <div class="section-header">
                    <h2 class="section-title">Provider Management</h2>
                    <div class="section-actions">
                        <button class="btn btn-primary" onclick="addNewProvider()">
                            ➕ Add New Provider
                        </button>
                        <button class="btn btn-secondary" onclick="refreshProviders()">
                            🔄 Refresh
                        </button>
                    </div>
                </div>
                <div class="provider-list" id="providerList">
                    <!-- Providers will be dynamically loaded here -->
                </div>
                <div class="empty-state" id="emptyState" style="display: none;">
                    <div style="text-align: center; padding: 40px; color: #657786;">
                        <div style="font-size: 4em; margin-bottom: 20px;">📝</div>
                        <h3 style="margin-bottom: 10px; color: #14171a;">No Providers Configured</h3>
                        <p style="margin-bottom: 20px;">Get started by adding your first API provider.</p>
                        <button class="btn btn-primary" onclick="addNewProvider()">
                            ➕ Add First Provider
                        </button>
                    </div>
                </div>
            </div>

            <!-- Model Management Tab -->
            <div class="tab-content" id="models-tab">
                <div class="section-header">
                    <h2 class="section-title">Model Management</h2>
                    <div class="section-actions">
                        <button class="btn btn-primary" onclick="refreshModels()">
                            🔄 Refresh Models
                        </button>
                    </div>
                </div>

                <!-- Active Models Section -->
                <div class="model-section">
                    <div class="model-section-header">
                        <h3 class="model-section-title">📊 Active Configuration Models</h3>
                        <span class="model-count" id="activeModelCount">0</span>
                    </div>
                    <div class="models-container" id="activeModelsContainer">
                        <div class="loading-message">
                            Loading active models...
                        </div>
                    </div>
                </div>

                <!-- Provider Model Pool Section -->
                <div class="model-section">
                    <div class="model-section-header">
                        <h3 class="model-section-title">🏊 Provider Model Pool</h3>
                        <span class="model-count" id="poolModelCount">0</span>
                        <button class="btn btn-sm btn-info" onclick="showProviderPool()">
                            Manage Pool
                        </button>
                    </div>
                    <div class="models-container" id="poolModelsContainer">
                        <div class="loading-message">
                            Loading pool models...
                        </div>
                    </div>
                </div>

                <!-- Blacklisted Models Section (Collapsible) -->
                <div class="model-section collapsible">
                    <div class="model-section-header clickable" onclick="toggleBlacklistSection()">
                        <h3 class="model-section-title">🚫 Blacklisted Models</h3>
                        <span class="model-count" id="blacklistModelCount">0</span>
                        <span class="collapse-indicator" id="blacklistIndicator">▼</span>
                    </div>
                    <div class="models-container collapsed" id="blacklistModelsContainer">
                        <div class="loading-message">
                            Loading blacklisted models...
                        </div>
                    </div>
                </div>

                <!-- Model Edit Modal -->
                <div class="modal" id="modelEditModal">
                    <div class="modal-content" style="width: 600px;">
                        <div class="modal-header">
                            <h3 id="modelEditTitle">Edit Model</h3>
                            <span class="close-btn" onclick="closeModal('modelEditModal')">&times;</span>
                        </div>
                        <div class="modal-body">
                            <form id="modelEditForm">
                                <div class="form-group">
                                    <label for="editModelName">Model Name:</label>
                                    <input type="text" id="editModelName" readonly style="background: #f5f5f5;">
                                </div>
                                
                                <div class="form-group">
                                    <label for="editMaxTokens">Max Tokens:</label>
                                    <input type="number" id="editMaxTokens" min="1000" max="2000000" step="1000">
                                </div>
                                
                                <div class="form-group">
                                    <label for="editDescription">Description:</label>
                                    <textarea id="editDescription" rows="3"></textarea>
                                </div>
                                
                                <div class="form-group">
                                    <label for="editStatus">Status:</label>
                                    <select id="editStatus">
                                        <option value="active">Active</option>
                                        <option value="blacklisted">Blacklisted</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label>
                                        <input type="checkbox" id="editManualOverride">
                                        Manual Override (prevents auto-updates)
                                    </label>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="closeModal('modelEditModal')">Cancel</button>
                            <button class="btn btn-primary" onclick="saveModelChanges()">Save Changes</button>
                        </div>
                    </div>
                </div>

                <!-- Blacklist Modal -->
                <div class="modal" id="blacklistModal">
                    <div class="modal-content" style="width: 800px;">
                        <div class="modal-header">
                            <h3>Model Blacklist</h3>
                            <span class="close-btn" onclick="closeModal('blacklistModal')">&times;</span>
                        </div>
                        <div class="modal-body">
                            <div id="blacklistContent">
                                Loading blacklist...
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="closeModal('blacklistModal')">Close</button>
                        </div>
                    </div>
                </div>

                <!-- Provider Pool Modal -->
                <div class="modal" id="providerPoolModal">
                    <div class="modal-content" style="width: 900px;">
                        <div class="modal-header">
                            <h3>Provider Pool</h3>
                            <span class="close-btn" onclick="closeModal('providerPoolModal')">&times;</span>
                        </div>
                        <div class="modal-body">
                            <div id="providerPoolContent">
                                Loading provider pool...
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="closeModal('providerPoolModal')">Close</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Router Table Tab -->
            <div class="tab-content" id="router-tab">
                <div class="section-header">
                    <h2 class="section-title">Virtual Model Routes</h2>
                    <div class="section-actions">
                        <button class="btn btn-primary" onclick="createVirtualCategory()">
                            ➕ Add Category
                        </button>
                        <button class="btn btn-secondary" onclick="exportRoutingConfig()">
                            📤 Export Routes
                        </button>
                        <button class="btn btn-secondary" onclick="refreshVirtualRoutes()">
                            🔄 Refresh
                        </button>
                    </div>
                </div>
                
                <div class="virtual-routes-container">
                    <div class="virtual-categories" id="virtualCategoriesList">
                        <!-- Virtual categories will be loaded here -->
                    </div>
                    
                    <div class="available-models-sidebar" id="availableModelsSidebar">
                        <h3>Available Models</h3>
                        <div class="search-box">
                            <input type="text" placeholder="Search models..." id="modelSearchInput" oninput="filterAvailableModels()">
                        </div>
                        <div class="available-models-list" id="availableModelsList">
                            <!-- Available models will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Configuration Tab -->
            <div class="tab-content" id="config-tab">
                <div class="section-header">
                    <h2 class="section-title">Global Configuration</h2>
                    <div class="section-actions">
                        <button class="btn btn-primary" onclick="saveGlobalConfig()">
                            💾 Save Config
                        </button>
                        <button class="btn btn-secondary" onclick="exportConfig()">
                            📤 Export
                        </button>
                        <button class="btn btn-secondary" onclick="importConfig()">
                            📥 Import
                        </button>
                    </div>
                </div>
                <div class="config-grid">
                    <div class="config-card">
                        <div class="config-card-title">Load Balancing</div>
                        <div class="config-card-content">
                            <div class="form-group">
                                <label class="form-label">Strategy</label>
                                <select class="form-select" id="loadBalancingStrategy">
                                    <option value="round_robin">Round Robin</option>
                                    <option value="weighted">Weighted</option>
                                    <option value="random">Random</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <div class="form-checkbox">
                                    <input type="checkbox" id="enableFailover">
                                    <label for="enableFailover">Enable Failover</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="config-card">
                        <div class="config-card-title">Rate Limiting</div>
                        <div class="config-card-content">
                            <div class="form-group">
                                <label class="form-label">Requests per minute</label>
                                <input type="number" class="form-input" id="rateLimit" value="60">
                            </div>
                            <div class="form-group">
                                <div class="form-checkbox">
                                    <input type="checkbox" id="enableRateLimit">
                                    <label for="enableRateLimit">Enable Rate Limiting</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="config-card">
                        <div class="config-card-title">Monitoring</div>
                        <div class="config-card-content">
                            <div class="form-group">
                                <div class="form-checkbox">
                                    <input type="checkbox" id="enableLogging">
                                    <label for="enableLogging">Enable Request Logging</label>
                                </div>
                            </div>
                            <div class="form-group">
                                <div class="form-checkbox">
                                    <input type="checkbox" id="enableMetrics">
                                    <label for="enableMetrics">Enable Metrics Collection</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Key Modal -->
    <div class="modal" id="keyModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Add New API Key</h2>
            </div>
            <form id="keyForm">
                <div class="form-group">
                    <label class="form-label">Provider</label>
                    <select class="form-select" id="modalProvider" disabled>
                        <option>Loading...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Authentication Type</label>
                    <select class="form-select" id="modalAuthType">
                        <option value="api_key">API Key</option>
                        <option value="oauth">OAuth Token</option>
                    </select>
                </div>
                <div class="form-group" id="keyValueGroup">
                    <label class="form-label">API Key</label>
                    <input type="password" class="form-input" id="modalKeyValue" placeholder="sk-your-api-key-here">
                    <div id="keyValidationMessage" style="display: none; margin-top: 5px; font-size: 0.9em;"></div>
                </div>
                <div class="form-group">
                    <div class="form-checkbox">
                        <input type="checkbox" id="modalUseFile">
                        <label for="modalUseFile">Store in file</label>
                    </div>
                </div>
                <div class="form-group" id="filePathGroup" style="display: none;">
                    <label class="form-label">File Path</label>
                    <input type="text" class="form-input" id="modalFilePath" placeholder="./keys/api-key.txt">
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Key</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add/Edit Provider Modal -->
    <div class="modal" id="providerModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="providerModalTitle">Add New Provider</h2>
            </div>
            <form id="providerForm">
                <div class="form-group">
                    <label class="form-label">Provider Name</label>
                    <input type="text" class="form-input" id="providerName" placeholder="my-provider" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Protocol Type</label>
                    <select class="form-select" id="providerProtocol">
                        <option value="anthropic">Anthropic (Claude)</option>
                        <option value="openai">OpenAI (GPT)</option>
                        <option value="gemini">Google Gemini</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Base URL</label>
                    <input type="url" class="form-input" id="providerBaseUrl" placeholder="https://api.provider.com/v1" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Models (comma-separated)</label>
                    <input type="text" class="form-input" id="providerModels" placeholder="model-1,model-2,model-3">
                </div>
                <div class="form-group">
                    <label class="form-label">Authentication Type</label>
                    <select class="form-select" id="providerAuthType">
                        <option value="api_key">API Key</option>
                        <option value="oauth">OAuth Token</option>
                    </select>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeProviderModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Provider</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add/Edit Router Rule Modal -->
    <div class="modal" id="routerModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="routerModalTitle">Add Router Rule</h2>
            </div>
            <form id="routerForm">
                <div class="form-group">
                    <label class="form-label">Pattern</label>
                    <input type="text" class="form-input" id="routerPattern" placeholder="/chat/completions" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Provider</label>
                    <select class="form-select" id="routerProvider" required>
                        <option value="">Select Provider</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Model</label>
                    <select class="form-select" id="routerModel">
                        <option value="">Any Model</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Priority</label>
                    <select class="form-select" id="routerPriority">
                        <option value="high">High</option>
                        <option value="medium" selected>Medium</option>
                        <option value="low">Low</option>
                    </select>
                </div>
                <div class="form-group">
                    <div class="form-checkbox">
                        <input type="checkbox" id="routerEnabled" checked>
                        <label for="routerEnabled">Enable Rule</label>
                    </div>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeRouterModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Rule</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Test Result Modal -->
    <div class="modal" id="testModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">API Key Test Results</h2>
            </div>
            <div id="testResults">
                <!-- Test results will be displayed here -->
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeTestModal()">Close</button>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let providers = [];
        let currentProvider = null;
        let currentKeyIndex = null;
        let editMode = false;
        let providerEditMode = false;

        // 初始化默认路由规则
        function initializeDefaultRoutes() {
            if (routerRules.length === 0) {
                routerRules = [
                    {
                        id: 'route-gpt-4',
                        pattern: 'gpt-4*',
                        provider: 'OpenAI Compatible',
                        model: 'auto',
                        priority: 'high',
                        enabled: true
                    },
                    {
                        id: 'route-claude',
                        pattern: 'claude-*',
                        provider: 'Anthropic Claude',
                        model: 'auto',
                        priority: 'high',
                        enabled: true
                    },
                    {
                        id: 'route-gemini',
                        pattern: 'gemini-*',
                        provider: 'Google Gemini',
                        model: 'auto',
                        priority: 'medium',
                        enabled: true
                    }
                ];
                renderRouterTable();
            }
        }

        // Initialize the application
        function init() {
            loadProviders();
            initializeDefaultRoutes();
            setupEventListeners();
        }

        // Load providers from API
        async function loadProviders() {
            try {
                const response = await fetch('/api/providers');
                const result = await response.json();
                
                if (result.success && result.data) {
                    providers = result.data;
                } else {
                    providers = [];
                }
                
                renderProviders();
            } catch (error) {
                console.error('Failed to load providers:', error);
                providers = [];
                renderProviders();
                showNotification('Failed to load providers', 'error');
            }
        }

        // Render all providers
        function renderProviders() {
            const container = document.getElementById('providerList');
            const emptyState = document.getElementById('emptyState');
            
            if (!providers || providers.length === 0) {
                container.innerHTML = '';
                emptyState.style.display = 'block';
            } else {
                container.innerHTML = providers.map(provider => renderProvider(provider)).join('');
                emptyState.style.display = 'none';
            }
        }

        // Render a single provider
        function renderProvider(provider) {
            const keys = Array.isArray(provider.api_key) ? provider.api_key : [provider.api_key];
            const keyCount = keys.length;
            const isMultiKey = keyCount > 1;
            const models = provider.models || [];
            const hasModels = models.length > 0;

            return `
                <div class="provider-card">
                    <div class="provider-header">
                        <div>
                            <div class="provider-name">${provider.name}</div>
                            <div class="provider-info">${provider.api_base_url}</div>
                            <div class="protocol-type">Protocol: ${provider.protocol}</div>
                        </div>
                        <div class="auth-type-badge auth-${provider.auth_type}">
                            ${provider.auth_type.replace('_', ' ')}
                        </div>
                    </div>

                    ${hasModels ? `
                        <div class="provider-models-info">
                            <h5>Available Models (${models.length})</h5>
                            <div class="provider-models-list">
                                ${models.slice(0, 8).map(model => {
                                    const modelName = typeof model === 'string' ? model : model.name;
                                    const displayTokens = typeof model === 'object' ? (model.auto_detected_tokens || model.max_tokens) : null;
                                    const maxTokens = displayTokens ? ` (${Math.round(displayTokens/1000)}K)` : '';
                                    const isDetected = typeof model === 'object' && model.auto_detected_tokens ? ' ✓' : '';
                                    return `<span class="model-tag" title="${typeof model === 'object' && model.description ? model.description : modelName}">${modelName}${maxTokens}${isDetected}</span>`;
                                }).join('')}
                                ${models.length > 8 ? `<span class="model-tag" style="background: #f0f3f4; color: #657786;">+${models.length - 8} more</span>` : ''}
                            </div>
                        </div>
                    ` : ''}

                    <div class="keys-section">
                        <div class="keys-header">
                            <div class="keys-title">API Keys</div>
                            <div class="keys-count">${keyCount} key${keyCount > 1 ? 's' : ''}</div>
                        </div>
                        <div class="key-list">
                            ${keys.map((key, index) => `
                                <div class="key-item">
                                    <div class="key-info">
                                        <div class="key-index">${index + 1}</div>
                                        <div class="key-value" title="${key}">${maskKey(key)}</div>
                                        <div class="key-type">${getKeyType(key)}</div>
                                    </div>
                                    <div class="key-actions">
                                        <button class="btn btn-small btn-secondary" onclick="testKey('${provider.name}', ${index})">
                                            🧪 Test
                                        </button>
                                        <button class="btn btn-small btn-primary" onclick="editKey('${provider.name}', ${index})">
                                            ✏️ Edit
                                        </button>
                                        <button class="btn btn-small btn-danger" onclick="removeKey('${provider.name}', ${index})">
                                            🗑️
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <div class="provider-actions">
                        <button class="btn btn-primary" onclick="addKey('${provider.name}')">
                            ➕ Add Key
                        </button>
                        ${isMultiKey ? `
                            <button class="btn btn-secondary" onclick="testRotation('${provider.name}')">
                                🔄 Test Rotation
                            </button>
                        ` : ''}
                        <button class="btn btn-success" onclick="testProvider('${provider.name}')">
                            🚀 Test Provider
                        </button>
                        <button class="btn btn-primary" onclick="getProviderModels('${provider.name}')">
                            📋 Get Models
                        </button>
                        <button class="btn btn-secondary" onclick="editProvider('${provider.name}')">
                            ✏️ Edit
                        </button>
                        <button class="btn btn-danger" onclick="deleteProvider('${provider.name}')">
                            🗑️ Delete
                        </button>
                    </div>
                </div>
            `;
        }

        // Utility functions
        function maskKey(key) {
            if (key.startsWith('./') || key.startsWith('/')) {
                return `📁 ${key}`;
            }
            if (key.length < 10) return '*'.repeat(key.length);
            return key.substring(0, 6) + '*'.repeat(Math.max(0, key.length - 10)) + key.substring(key.length - 4);
        }

        function getKeyType(key) {
            if (key.startsWith('./') || key.startsWith('/')) return 'file';
            if (key.includes('oauth')) return 'oauth';
            return 'direct';
        }

        // Modal management
        function openModal(title, provider = null, keyIndex = null) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalProvider').value = provider || '';
            document.getElementById('keyModal').classList.add('active');
            
            currentProvider = provider;
            currentKeyIndex = keyIndex;
            editMode = keyIndex !== null;

            // Pre-fill form if editing
            if (editMode) {
                const providerObj = providers.find(p => p.name === provider);
                const keys = Array.isArray(providerObj.api_key) ? providerObj.api_key : [providerObj.api_key];
                const key = keys[keyIndex];
                
                document.getElementById('modalAuthType').value = providerObj.auth_type || 'api_key';
                document.getElementById('modalKeyValue').value = '';
                
                if (key.startsWith('./') || key.startsWith('/')) {
                    document.getElementById('modalUseFile').checked = true;
                    document.getElementById('modalFilePath').value = key;
                    toggleFilePathGroup();
                }
            }
        }

        function closeModal() {
            document.getElementById('keyModal').classList.remove('active');
            document.getElementById('keyForm').reset();
            
            // Clear validation state
            const messageElement = document.getElementById('keyValidationMessage');
            const keyInput = document.getElementById('modalKeyValue');
            messageElement.style.display = 'none';
            keyInput.style.borderColor = '#e1e8ed';
            
            currentProvider = null;
            currentKeyIndex = null;
            editMode = false;
        }

        function closeTestModal() {
            document.getElementById('testModal').classList.remove('active');
        }

        function toggleFilePathGroup() {
            const useFile = document.getElementById('modalUseFile').checked;
            const filePathGroup = document.getElementById('filePathGroup');
            const keyValueGroup = document.getElementById('keyValueGroup');
            const messageElement = document.getElementById('keyValidationMessage');
            const keyInput = document.getElementById('modalKeyValue');
            
            // Clear validation message when switching modes
            messageElement.style.display = 'none';
            keyInput.style.borderColor = '#e1e8ed';
            
            if (useFile) {
                filePathGroup.style.display = 'block';
                keyValueGroup.querySelector('label').textContent = 'Key Content';
                keyValueGroup.querySelector('input').placeholder = 'Key content to save in file';
            } else {
                filePathGroup.style.display = 'none';
                keyValueGroup.querySelector('label').textContent = 'API Key';
                keyValueGroup.querySelector('input').placeholder = 'sk-your-api-key-here';
            }
            
            // Re-validate after switching modes
            setTimeout(validateKeyInput, 100);
        }

        // 获取provider模型列表
        async function getProviderModels(providerName) {
            try {
                const provider = providers.find(p => p.name === providerName);
                if (!provider) {
                    showNotification('Provider not found', 'error');
                    return;
                }
                
                // 检查是否有API key
                const keys = Array.isArray(provider.api_key) ? provider.api_key : [provider.api_key];
                const hasValidKey = keys.some(key => key && key.trim() !== '');
                
                if (!hasValidKey) {
                    showNotification('No API key configured. Please add an API key first.', 'warning');
                    return;
                }
                
                showNotification('Fetching models from API...', 'info');
                
                // 发送请求获取模型
                const response = await fetch(`/api/providers/${encodeURIComponent(providerName)}/models`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({})
                });
                
                const result = await response.json();
                
                if (result.success && result.data) {
                    // 更新本地provider数据
                    const providerIndex = providers.findIndex(p => p.name === providerName);
                    if (providerIndex !== -1) {
                        providers[providerIndex].models = result.data.models;
                    }
                    
                    renderProviders();
                    showNotification(`Successfully fetched ${result.data.count} models`, 'success');
                    
                    // 显示模型列表
                    showModelsModal(providerName, result.data.models);
                } else {
                    console.error('Failed to get models:', result);
                    showNotification(`Failed to fetch models: ${result.error}`, 'error');
                }
            } catch (error) {
                console.error('Error getting models:', error);
                showNotification(`Error fetching models: ${error.message}`, 'error');
            }
        }
        
        // 显示模型列表模态框
        function showModelsModal(providerName, models) {
            const modelsHtml = `
                <div class="models-result">
                    <h4>Available Models for ${providerName}</h4>
                    <p><strong>Total Models:</strong> ${models.length}</p>
                    <div class="models-list" style="max-height: 300px; overflow-y: auto; margin-top: 15px;">
                        ${models.map((model, index) => {
                            const modelName = typeof model === 'string' ? model : model.name;
                            const modelId = typeof model === 'object' ? (model.id || model.name) : model;
                            const configuredTokens = typeof model === 'object' && model.max_tokens ? model.max_tokens : 'Unknown';
                            const autoDetectedTokens = typeof model === 'object' ? model.auto_detected_tokens : null;
                            // 优先显示检测到的tokens，如果没有则显示配置的tokens
                            const maxTokens = autoDetectedTokens || configuredTokens;
                            const description = typeof model === 'object' && model.description ? model.description : '';
                            const verified = typeof model === 'object' ? model.verified : false;
                            const blacklisted = typeof model === 'object' ? model.blacklisted : false;
                            const status = typeof model === 'object' ? model.status : 'unknown';
                            
                            const statusColor = blacklisted ? '#f44336' : (verified ? '#4caf50' : '#ff9800');
                            const statusText = blacklisted ? 'Blacklisted' : (verified ? 'Verified' : 'Unverified');
                            
                            return `
                            <div class="enhanced-model-item" style="padding: 15px; margin: 8px 0; background: #ffffff; border-radius: 8px; border: 1px solid #e0e0e0; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                <!-- Model Header -->
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <strong style="font-family: monospace; color: #1da1f2; font-size: 1.1em;">${index + 1}. ${modelName}</strong>
                                        <span style="background: ${statusColor}; color: white; padding: 2px 6px; border-radius: 12px; font-size: 0.7em; font-weight: 500;">
                                            ${statusText}
                                        </span>
                                    </div>
                                    <div style="display: flex; gap: 6px;">
                                        <button onclick="verifyModel('${providerName}', '${modelId}')" 
                                                style="background: #4caf50; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 0.8em; cursor: pointer;"
                                                title="验证模型（真实对话测试）">
                                            🔍 Verify
                                        </button>
                                        <button onclick="detectTokens('${providerName}', '${modelId}')" 
                                                style="background: #ff9800; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 0.8em; cursor: pointer;"
                                                title="自动检测max_tokens">
                                            📊 Detect
                                        </button>
                                        <button onclick="blacklistModel('${providerName}', '${modelId}')" 
                                                style="background: #f44336; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 0.8em; cursor: pointer;"
                                                title="加入黑名单">
                                            🚫 Block
                                        </button>
                                        <button onclick="addToPool('${providerName}', '${modelId}')" 
                                                style="background: #9c27b0; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 0.8em; cursor: pointer;"
                                                title="添加到Provider Pool">
                                            ➕ Pool
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Token Information -->
                                <div style="display: flex; gap: 12px; margin-bottom: 8px;">
                                    <div style="display: flex; align-items: center; gap: 4px;">
                                        <span style="color: #666; font-size: 0.9em;">Max Tokens:</span>
                                        <span style="background: #e1f5fe; color: #0277bd; padding: 2px 8px; border-radius: 12px; font-size: 0.8em; font-weight: 500;">
                                            ${maxTokens.toLocaleString()}
                                        </span>
                                    </div>
                                    ${autoDetectedTokens ? `
                                        <div style="display: flex; align-items: center; gap: 4px;">
                                            <span style="color: #666; font-size: 0.9em;">Auto Detected:</span>
                                            <span style="background: #e8f5e8; color: #2e7d32; padding: 2px 8px; border-radius: 12px; font-size: 0.8em; font-weight: 500;">
                                                ${autoDetectedTokens.toLocaleString()}
                                            </span>
                                        </div>
                                    ` : ''}
                                </div>
                                
                                <!-- Description -->
                                ${description ? `<div style="color: #657786; font-size: 0.85em; font-style: italic; margin-bottom: 8px;">${description}</div>` : ''}
                                
                                <!-- Status Info -->
                                ${typeof model === 'object' && model.last_verification ? `
                                    <div style="color: #999; font-size: 0.8em;">
                                        Last verified: ${new Date(model.last_verification).toLocaleString()}
                                    </div>
                                ` : ''}
                            </div>
                            `;
                        }).join('')}
                    </div>
                    <div style="margin-top: 15px; padding: 10px; background: #e8f4fd; border-radius: 4px; font-size: 0.9em; color: #1da1f2;">
                        ℹ️ Models have been automatically updated in the provider configuration.
                    </div>
                </div>
            `;
            
            document.getElementById('testResults').innerHTML = modelsHtml;
            document.getElementById('testModal').classList.add('active');
        }

        // Key management functions
        function addKey(providerName) {
            openModal('Add New API Key', providerName);
        }

        function editKey(providerName, keyIndex) {
            openModal('Edit API Key', providerName, keyIndex);
        }

        async function removeKey(providerName, keyIndex) {
            if (confirm('Are you sure you want to remove this API key?')) {
                try {
                    const provider = providers.find(p => p.name === providerName);
                    if (!provider) {
                        showNotification('Provider not found', 'error');
                        return;
                    }

                    // Create updated provider data
                    const updatedProvider = { ...provider };
                    
                    if (Array.isArray(updatedProvider.api_key)) {
                        updatedProvider.api_key.splice(keyIndex, 1);
                        
                        // If no keys left, set to empty array
                        if (updatedProvider.api_key.length === 0) {
                            updatedProvider.api_key = [''];
                        }
                        // If only one key left, convert to single string
                        else if (updatedProvider.api_key.length === 1) {
                            updatedProvider.api_key = updatedProvider.api_key[0];
                        }
                    } else {
                        // Single key, set to empty string
                        updatedProvider.api_key = [''];
                    }

                    showNotification('Removing key...', 'info');

                    // Send PUT request to update provider
                    const response = await fetch(`/api/providers/${providerName}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(updatedProvider)
                    });

                    if (!response.ok) {
                        const error = await response.json().catch(() => ({ message: 'Unknown error' }));
                        throw new Error(error.message || `HTTP ${response.status}`);
                    }

                    // Update local data only after successful API call
                    const index = providers.findIndex(p => p.name === providerName);
                    if (index !== -1) {
                        providers[index] = updatedProvider;
                    }
                    
                    renderProviders();
                    showNotification('Key removed successfully', 'success');
                } catch (error) {
                    console.error('Failed to remove key:', error);
                    showNotification(`Failed to remove key: ${error.message}`, 'error');
                }
            }
        }

        async function testKey(providerName, keyIndex) {
            try {
                const provider = providers.find(p => p.name === providerName);
                if (!provider) {
                    showNotification('Provider not found', 'error');
                    return;
                }
                
                const keys = Array.isArray(provider.api_key) ? provider.api_key : [provider.api_key];
                const key = keys[keyIndex];
                
                if (!key || key.trim() === '') {
                    showNotification('No API key to test', 'warning');
                    return;
                }
                
                showNotification('Testing key...', 'info');
                
                // 发送请求测试单个key
                const response = await fetch(`/api/providers/${encodeURIComponent(providerName)}/test`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ api_key: key, testAllKeys: false })
                });
                
                const result = await response.json();
                
                if (result.success && result.data && result.data.testResults.length > 0) {
                    const testResult = result.data.testResults[0];
                    showTestResult(providerName, {
                        success: testResult.success,
                        statusCode: testResult.statusCode,
                        responseTime: testResult.responseTime,
                        message: testResult.message,
                        keyTested: testResult.api_key,
                        models: testResult.models
                    });
                } else {
                    console.error('Failed to test key:', result);
                    showNotification(`Failed to test key: ${result.error}`, 'error');
                }
            } catch (error) {
                console.error('Error testing key:', error);
                showNotification(`Error testing key: ${error.message}`, 'error');
            }
        }

        async function testProvider(providerName) {
            try {
                const provider = providers.find(p => p.name === providerName);
                if (!provider) {
                    showNotification('Provider not found', 'error');
                    return;
                }
                
                const keys = Array.isArray(provider.api_key) ? provider.api_key : [provider.api_key];
                
                if (!keys.some(key => key && key.trim() !== '')) {
                    showNotification('No API keys to test', 'warning');
                    return;
                }
                
                showNotification('Testing all keys...', 'info');
                
                // 发送请求测试所有keys
                const response = await fetch(`/api/providers/${encodeURIComponent(providerName)}/test`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ testAllKeys: true })
                });
                
                const result = await response.json();
                
                if (result.success && result.data) {
                    showProviderTestResult(providerName, result.data.testResults.map((r, index) => ({
                        keyIndex: index,
                        key: r.api_key,
                        success: r.success,
                        responseTime: r.responseTime,
                        message: r.message,
                        models: r.models
                    })));
                } else {
                    console.error('Failed to test provider:', result);
                    showNotification(`Failed to test provider: ${result.error}`, 'error');
                }
            } catch (error) {
                console.error('Error testing provider:', error);
                showNotification(`Error testing provider: ${error.message}`, 'error');
            }
        }

        function testRotation(providerName) {
            const provider = providers.find(p => p.name === providerName);
            const keys = Array.isArray(provider.api_key) ? provider.api_key : [provider.api_key];
            
            const rotationResults = [];
            for (let i = 0; i < 5; i++) {
                const selectedIndex = i % keys.length;
                const selectedKey = keys[selectedIndex];
                rotationResults.push({
                    round: i + 1,
                    selectedIndex: selectedIndex,
                    selectedKey: maskKey(selectedKey)
                });
            }

            showRotationDemo(providerName, rotationResults);
        }

        // Result display functions
        function showTestResult(providerName, result) {
            const resultsHtml = `
                <div class="test-result ${result.success ? 'test-success' : 'test-error'}">
                    <h4>Provider: ${providerName}</h4>
                    <p><strong>Status:</strong> ${result.success ? 'Success' : 'Failed'}</p>
                    <p><strong>Status Code:</strong> ${result.statusCode}</p>
                    <p><strong>Response Time:</strong> ${result.responseTime.toFixed(0)}ms</p>
                    <p><strong>Message:</strong> ${result.message}</p>
                    <p><strong>Key Tested:</strong> ${result.keyTested}</p>
                    ${result.models && result.models.length > 0 ? `
                        <p><strong>Models Found:</strong> ${result.models.length}</p>
                        <div style="max-height: 150px; overflow-y: auto; margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 4px;">
                            ${result.models.slice(0, 10).map(model => {
                                const modelName = typeof model === 'string' ? model : model.name;
                                return `<div style="font-family: monospace; font-size: 0.8em; margin: 2px 0;">${modelName}</div>`;
                            }).join('')}
                            ${result.models.length > 10 ? `<div style="font-style: italic; color: #657786; margin-top: 5px;">... and ${result.models.length - 10} more</div>` : ''}
                        </div>
                    ` : ''}
                </div>
            `;
            
            document.getElementById('testResults').innerHTML = resultsHtml;
            document.getElementById('testModal').classList.add('active');
        }

        function showProviderTestResult(providerName, results) {
            const successCount = results.filter(r => r.success).length;
            const totalCount = results.length;
            
            const resultsHtml = `
                <div class="test-result ${successCount === totalCount ? 'test-success' : 'test-error'}">
                    <h4>Provider Test: ${providerName}</h4>
                    <p><strong>Success Rate:</strong> ${successCount}/${totalCount} keys</p>
                    ${results.map(r => `
                        <div style="margin: 10px 0; padding: 10px; background: ${r.success ? '#d4edda' : '#f8d7da'}; border-radius: 4px;">
                            <strong>Key ${r.keyIndex + 1}:</strong> ${r.success ? '✅ Success' : '❌ Failed'} 
                            (${r.responseTime.toFixed(0)}ms) - ${r.key}
                            ${r.models && r.models.length > 0 ? `<div style="margin-top: 5px; font-size: 0.8em; color: #657786;">Models: ${r.models.length}</div>` : ''}
                        </div>
                    `).join('')}
                </div>
            `;
            
            document.getElementById('testResults').innerHTML = resultsHtml;
            document.getElementById('testModal').classList.add('active');
        }

        function showRotationDemo(providerName, rotationResults) {
            const resultsHtml = `
                <div class="rotation-demo">
                    <h4>Key Rotation Demo: ${providerName}</h4>
                    <p>Simulating round-robin key rotation:</p>
                    ${rotationResults.map(r => `
                        <div class="rotation-step">
                            Round ${r.round}: Selected Key #${r.selectedIndex + 1} → ${r.selectedKey}
                        </div>
                    `).join('')}
                </div>
            `;
            
            document.getElementById('testResults').innerHTML = resultsHtml;
            document.getElementById('testModal').classList.add('active');
        }

        // Provider management functions
        function addNewProvider() {
            providerEditMode = false;
            currentProvider = null;
            
            document.getElementById('providerModalTitle').textContent = 'Add New Provider';
            document.getElementById('providerForm').reset();
            document.getElementById('providerModal').classList.add('active');
        }
        
        function editProvider(providerName) {
            providerEditMode = true;
            currentProvider = providerName;
            
            const provider = providers.find(p => p.name === providerName);
            if (!provider) {
                showNotification('Provider not found', 'error');
                return;
            }
            
            document.getElementById('providerModalTitle').textContent = 'Edit Provider';
            document.getElementById('providerName').value = provider.name;
            document.getElementById('providerProtocol').value = provider.protocol || 'openai';
            document.getElementById('providerBaseUrl').value = provider.api_base_url;
            document.getElementById('providerModels').value = Array.isArray(provider.models) ? provider.models.join(', ') : '';
            document.getElementById('providerAuthType').value = provider.auth_type || 'api_key';
            
            document.getElementById('providerModal').classList.add('active');
        }
        
        async function deleteProvider(providerName) {
            if (confirm(`Are you sure you want to delete provider "${providerName}"? This action cannot be undone.`)) {
                try {
                    // Find provider to get its ID
                    const provider = providers.find(p => p.name === providerName);
                    if (!provider) {
                        showNotification('Provider not found', 'error');
                        return;
                    }

                    showNotification('Deleting provider...', 'info');

                    // Send DELETE request to backend
                    const response = await fetch(`/api/providers/${provider.name}`, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });

                    if (!response.ok) {
                        const error = await response.json().catch(() => ({ message: 'Unknown error' }));
                        throw new Error(error.message || `HTTP ${response.status}`);
                    }

                    // Update local data only after successful API call
                    const index = providers.findIndex(p => p.name === providerName);
                    if (index !== -1) {
                        providers.splice(index, 1);
                    }
                    
                    renderProviders();
                    showNotification('Provider deleted successfully', 'success');
                } catch (error) {
                    console.error('Failed to delete provider:', error);
                    showNotification(`Failed to delete provider: ${error.message}`, 'error');
                }
            }
        }
        
        async function refreshProviders() {
            showNotification('Refreshing providers...', 'info');
            await loadProviders();
        }
        
        function closeProviderModal() {
            document.getElementById('providerModal').classList.remove('active');
            document.getElementById('providerForm').reset();
            providerEditMode = false;
            currentProvider = null;
        }

        // Router management functions
        let routerRules = [];
        let routerEditMode = false;
        let currentRouterRuleIndex = null;
        
        // Virtual Routes Management Functions
        let virtualCategories = [];
        let availableModels = [];
        let selectedModelsForCategory = new Map();

        async function loadVirtualRoutes() {
            try {
                const response = await fetch('/api/virtual-routes');
                const result = await response.json();
                
                if (result.success) {
                    virtualCategories = result.data;
                    renderVirtualCategories();
                } else {
                    showNotification('Failed to load virtual routes', 'error');
                }
            } catch (error) {
                console.error('Error loading virtual routes:', error);
                showNotification('Error loading virtual routes', 'error');
            }
        }

        async function loadAvailableModels() {
            try {
                const response = await fetch('/api/virtual-routes/available-models');
                const result = await response.json();
                
                if (result.success) {
                    availableModels = result.data;
                    renderAvailableModels();
                } else {
                    showNotification('Failed to load available models', 'error');
                }
            } catch (error) {
                console.error('Error loading available models:', error);
                showNotification('Error loading available models', 'error');
            }
        }

        function renderVirtualCategories(filteredCategories = null) {
            const container = document.getElementById('virtualCategoriesList');
            const categoriesToRender = filteredCategories || virtualCategories;
            
            // Always show the search header
            let headerHtml = `
                <div class="categories-header">
                    <div class="search-box">
                        <input type="text" placeholder="Search categories..." id="categorySearchInput" oninput="filterVirtualCategories()">
                    </div>
                </div>
            `;
            
            if (categoriesToRender.length === 0) {
                container.innerHTML = headerHtml + `
                    <div class="empty-routes">
                        <div style="font-size: 2em; margin-bottom: 15px;">🛣️</div>
                        <div>No virtual model categories found</div>
                        <div style="font-size: 0.9em; margin-top: 10px; color: #657786;">
                            Create your first virtual model category to start organizing your routes
                        </div>
                    </div>
                `;
                return;
            }

            container.innerHTML = headerHtml + categoriesToRender.map(category => {
                const routeCount = category.routes ? category.routes.length : 0;
                return `
                    <div class="virtual-category" id="category-${category.name}">
                        <div class="virtual-category-header" onclick="toggleCategoryExpansion('${category.name}')">
                            <div class="virtual-category-title">
                                <span class="virtual-category-name">${category.display_name}</span>
                                <span class="virtual-category-badge">${routeCount} routes</span>
                            </div>
                            <div class="virtual-category-actions">
                                <button class="btn btn-small btn-secondary" onclick="event.stopPropagation(); editCategory('${category.name}')">⚙️</button>
                                <button class="btn btn-small btn-danger" onclick="event.stopPropagation(); deleteCategory('${category.name}')">🗑️</button>
                            </div>
                        </div>
                        <div class="virtual-category-content" id="content-${category.name}">
                            <div class="virtual-category-routes" id="routes-${category.name}">
                                ${renderCategoryRoutes(category)}
                            </div>
                            <div class="load-balancing-config">
                                <div class="load-balancing-title">Load Balancing Strategy</div>
                                <select class="load-balancing-select" onchange="updateLoadBalancing('${category.name}', this.value)">
                                    <option value="round_robin" ${category.load_balancing?.strategy === 'round_robin' ? 'selected' : ''}>Round Robin</option>
                                    <option value="weighted" ${category.load_balancing?.strategy === 'weighted' ? 'selected' : ''}>Weighted</option>
                                    <option value="priority" ${category.load_balancing?.strategy === 'priority' ? 'selected' : ''}>Priority</option>
                                    <option value="random" ${category.load_balancing?.strategy === 'random' ? 'selected' : ''}>Random</option>
                                </select>
                            </div>
                            <div class="add-route-section">
                                <button class="btn btn-primary" onclick="showAddRoutePanel('${category.name}')">
                                    ➕ Add Route to ${category.display_name}
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderCategoryRoutes(category) {
            if (!category.routes || category.routes.length === 0) {
                return `
                    <div class="empty-routes">
                        <div style="font-size: 1.5em; margin-bottom: 10px;">📭</div>
                        <div>No routes configured for ${category.display_name}</div>
                        <div style="font-size: 0.9em; color: #657786; margin-top: 5px;">
                            Select models from the sidebar or click "Add Route" below
                        </div>
                    </div>
                `;
            }

            return category.routes.map(route => `
                <div class="route-item">
                    <div class="route-info">
                        <div class="route-model">${route.model_name}</div>
                        <div class="route-provider">${route.provider_name}</div>
                        <div class="route-meta">
                            <span class="route-weight">Weight: ${route.weight}</span>
                            <span>Priority: ${route.priority}</span>
                            <span>Source: ${route.source}</span>
                        </div>
                    </div>
                    <div class="route-actions">
                        <button class="btn btn-small btn-secondary" onclick="editRoute('${category.name}', '${route.id}')">✏️</button>
                        <button class="btn btn-small btn-danger" onclick="removeRoute('${category.name}', '${route.id}')">🗑️</button>
                    </div>
                </div>
            `).join('');
        }

        function filterVirtualCategories() {
            const searchTerm = document.getElementById('categorySearchInput').value.toLowerCase();
            const filteredCategories = virtualCategories.filter(category => 
                category.name.toLowerCase().includes(searchTerm) ||
                category.display_name.toLowerCase().includes(searchTerm) ||
                category.description.toLowerCase().includes(searchTerm)
            );
            
            renderVirtualCategories(filteredCategories);
        }

        function renderAvailableModels() {
            const container = document.getElementById('availableModelsList');
            
            if (availableModels.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #657786;">
                        <div style="font-size: 1.5em; margin-bottom: 10px;">📦</div>
                        <div>No available models found</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = availableModels.map(model => `
                <div class="available-model-item" onclick="selectModelForRoute('${model.provider_id}', '${model.model_id}')">
                    <div class="available-model-info">
                        <div class="available-model-name">${model.model_name}</div>
                        <div class="available-model-provider">${model.provider_name} (${model.source})</div>
                    </div>
                    <div class="btn btn-small btn-primary">+</div>
                </div>
            `).join('');
        }

        function toggleCategoryExpansion(categoryName) {
            const content = document.getElementById(`content-${categoryName}`);
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
            } else {
                content.classList.add('expanded');
            }
        }

        async function createVirtualCategory() {
            const name = prompt('Enter virtual category name (e.g., "coding", "longtext"):');
            if (!name) return;

            const displayName = prompt('Enter display name:') || name;
            const description = prompt('Enter description:') || `${displayName} model category`;

            try {
                const response = await fetch('/api/virtual-routes/categories', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: name.toLowerCase(),
                        display_name: displayName,
                        description: description
                    })
                });

                const result = await response.json();
                if (result.success) {
                    showNotification(`Virtual category "${displayName}" created successfully`, 'success');
                    loadVirtualRoutes();
                } else {
                    showNotification(`Failed to create category: ${result.data.error}`, 'error');
                }
            } catch (error) {
                console.error('Error creating category:', error);
                showNotification('Error creating virtual category', 'error');
            }
        }

        async function removeRoute(categoryName, routeId) {
            if (!confirm('Are you sure you want to remove this route?')) return;

            try {
                const response = await fetch(`/api/virtual-routes/categories/${encodeURIComponent(categoryName)}/routes/${encodeURIComponent(routeId)}`, {
                    method: 'DELETE'
                });

                const result = await response.json();
                if (result.success) {
                    showNotification('Route removed successfully', 'success');
                    loadVirtualRoutes();
                } else {
                    showNotification(`Failed to remove route: ${result.data.error}`, 'error');
                }
            } catch (error) {
                console.error('Error removing route:', error);
                showNotification('Error removing route', 'error');
            }
        }

        function selectModelForRoute(providerId, modelId) {
            // Show category selection modal or add to currently expanded category
            const expandedCategory = document.querySelector('.virtual-category-content.expanded');
            if (expandedCategory) {
                const categoryName = expandedCategory.id.replace('content-', '');
                addModelToCategory(categoryName, providerId, modelId);
            } else {
                // Show category selection dialog
                const categoryNames = virtualCategories.map(c => c.name);
                const selectedCategory = prompt(`Select category to add this model to:\n${categoryNames.join(', ')}`);
                if (selectedCategory && categoryNames.includes(selectedCategory)) {
                    addModelToCategory(selectedCategory, providerId, modelId);
                }
            }
        }

        async function addModelToCategory(categoryName, providerId, modelId) {
            const model = availableModels.find(m => m.provider_id === providerId && m.model_id === modelId);
            if (!model) return;

            const weight = parseInt(prompt('Enter weight (1-10):', '1') || '1');
            const priority = parseInt(prompt('Enter priority (1-10):', '1') || '1');

            try {
                const response = await fetch(`/api/virtual-routes/categories/${encodeURIComponent(categoryName)}/routes`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        provider_id: model.provider_id,
                        provider_name: model.provider_name,
                        model_id: model.model_id,
                        model_name: model.model_name,
                        source: model.source,
                        weight: weight,
                        priority: priority
                    })
                });

                const result = await response.json();
                if (result.success) {
                    showNotification(`Model "${model.model_name}" added to ${categoryName} category`, 'success');
                    loadVirtualRoutes();
                } else {
                    showNotification(`Failed to add model: ${result.data.error}`, 'error');
                }
            } catch (error) {
                console.error('Error adding model to category:', error);
                showNotification('Error adding model to category', 'error');
            }
        }

        function refreshVirtualRoutes() {
            loadVirtualRoutes();
            loadAvailableModels();
            showNotification('Virtual routes refreshed', 'success');
        }

        async function exportRoutingConfig() {
            try {
                const response = await fetch('/api/virtual-routes/export');
                const result = await response.json();
                
                if (result.success) {
                    const blob = new Blob([JSON.stringify(result.data, null, 2)], {
                        type: 'application/json'
                    });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `virtual-routes-config-${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    showNotification('Routing configuration exported successfully', 'success');
                } else {
                    showNotification('Failed to export routing configuration', 'error');
                }
            } catch (error) {
                console.error('Error exporting routing config:', error);
                showNotification('Error exporting routing configuration', 'error');
            }
        }

        function filterAvailableModels() {
            const searchTerm = document.getElementById('modelSearchInput').value.toLowerCase();
            const filteredModels = availableModels.filter(model => 
                model.model_name.toLowerCase().includes(searchTerm) ||
                model.provider_name.toLowerCase().includes(searchTerm)
            );
            
            const container = document.getElementById('availableModelsList');
            container.innerHTML = filteredModels.map(model => `
                <div class="available-model-item" onclick="selectModelForRoute('${model.provider_id}', '${model.model_id}')">
                    <div class="available-model-info">
                        <div class="available-model-name">${model.model_name}</div>
                        <div class="available-model-provider">${model.provider_name} (${model.source})</div>
                    </div>
                    <div class="btn btn-small btn-primary">+</div>
                </div>
            `).join('');
        }
        
        // Global config functions
        function saveGlobalConfig() {
            showNotification('Global config saved', 'success');
        }
        
        function exportConfig() {
            const config = {
                providers: providers,
                routerRules: routerRules,
                globalSettings: {
                    loadBalancing: document.getElementById('loadBalancingStrategy').value,
                    enableFailover: document.getElementById('enableFailover').checked,
                    rateLimit: document.getElementById('rateLimit').value,
                    enableRateLimit: document.getElementById('enableRateLimit').checked,
                    enableLogging: document.getElementById('enableLogging').checked,
                    enableMetrics: document.getElementById('enableMetrics').checked
                }
            };
            
            const dataStr = JSON.stringify(config, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = 'multi-key-config.json';
            link.click();
            
            URL.revokeObjectURL(url);
            showNotification('Configuration exported successfully', 'success');
        }
        
        function importConfig() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const config = JSON.parse(e.target.result);
                            if (config.providers) {
                                providers = config.providers;
                                renderProviders();
                            }
                            if (config.routerRules) {
                                routerRules = config.routerRules;
                                renderRouterTable();
                            }
                            if (config.globalSettings) {
                                const settings = config.globalSettings;
                                document.getElementById('loadBalancingStrategy').value = settings.loadBalancing || 'round_robin';
                                document.getElementById('enableFailover').checked = settings.enableFailover || false;
                                document.getElementById('rateLimit').value = settings.rateLimit || 60;
                                document.getElementById('enableRateLimit').checked = settings.enableRateLimit || false;
                                document.getElementById('enableLogging').checked = settings.enableLogging || false;
                                document.getElementById('enableMetrics').checked = settings.enableMetrics || false;
                            }
                            showNotification('Configuration imported successfully', 'success');
                        } catch (error) {
                            console.error('Import error:', error);
                            showNotification('Failed to import configuration: Invalid JSON', 'error');
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }
        
        // Tab switching function
        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Remove active class from all tab buttons
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(tabName + '-tab').classList.add('active');
            
            // Add active class to selected tab button
            event.target.classList.add('active');
            
            // Load specific tab data
            if (tabName === 'models') {
                refreshModels();
            } else if (tabName === 'router') {
                loadVirtualRoutes();
                loadAvailableModels();
            }
        }

        // Real-time key validation function
        function validateKeyInput() {
            const keyValue = document.getElementById('modalKeyValue').value;
            const filePath = document.getElementById('modalFilePath').value;
            const useFile = document.getElementById('modalUseFile').checked;
            const messageElement = document.getElementById('keyValidationMessage');
            const keyInput = document.getElementById('modalKeyValue');
            
            if (!currentProvider) {
                return;
            }
            
            const provider = providers.find(p => p.name === currentProvider);
            if (!provider) {
                return;
            }
            
            const keyToCheck = useFile ? filePath : keyValue;
            
            if (!keyToCheck || keyToCheck.trim() === '') {
                messageElement.style.display = 'none';
                keyInput.style.borderColor = '#e1e8ed';
                return;
            }
            
            // Get existing keys
            const existingKeys = Array.isArray(provider.api_key) ? 
                provider.api_key : 
                [provider.api_key].filter(Boolean);
            
            // Check for duplicates (excluding current key if editing)
            let isDuplicate = false;
            if (editMode) {
                const otherKeys = existingKeys.filter((_, index) => index !== currentKeyIndex);
                isDuplicate = otherKeys.includes(keyToCheck);
            } else {
                isDuplicate = existingKeys.includes(keyToCheck);
            }
            
            if (isDuplicate) {
                messageElement.style.display = 'block';
                messageElement.style.color = '#e0245e';
                messageElement.textContent = '⚠️ This API key already exists in the provider';
                keyInput.style.borderColor = '#e0245e';
            } else {
                messageElement.style.display = 'block';
                messageElement.style.color = '#17bf63';
                messageElement.textContent = '✅ Key is unique and valid';
                keyInput.style.borderColor = '#17bf63';
            }
        }

        // Event listeners
        function setupEventListeners() {
            // Use file checkbox
            document.getElementById('modalUseFile').addEventListener('change', toggleFilePathGroup);

            // Auth type change
            document.getElementById('modalAuthType').addEventListener('change', function() {
                const authType = this.value;
                const keyLabel = document.querySelector('#keyValueGroup label');
                const keyInput = document.getElementById('modalKeyValue');
                
                if (authType === 'oauth') {
                    keyLabel.textContent = 'OAuth Token/Config';
                    keyInput.placeholder = 'OAuth token or JSON config';
                } else {
                    keyLabel.textContent = 'API Key';
                    keyInput.placeholder = 'sk-your-api-key-here';
                }
            });

            // Real-time key validation
            document.getElementById('modalKeyValue').addEventListener('input', function() {
                validateKeyInput();
            });
            
            document.getElementById('modalFilePath').addEventListener('input', function() {
                validateKeyInput();
            });
            
            // Form submission
            document.getElementById('keyForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const providerName = currentProvider;
                const keyValue = document.getElementById('modalKeyValue').value;
                const authType = document.getElementById('modalAuthType').value;
                const useFile = document.getElementById('modalUseFile').checked;
                const filePath = document.getElementById('modalFilePath').value;

                if (!keyValue) {
                    showNotification('Please enter a key value', 'error');
                    return;
                }

                if (useFile && !filePath) {
                    showNotification('Please specify a file path', 'error');
                    return;
                }

                // Find provider
                const provider = providers.find(p => p.name === providerName);
                if (!provider) {
                    showNotification('Provider not found', 'error');
                    return;
                }

                try {
                    const keyToStore = useFile ? filePath : keyValue;
                    
                    // Create updated provider data
                    const updatedProvider = { ...provider };
                    updatedProvider.auth_type = authType;

                    if (editMode) {
                        // Edit existing key - check for duplicates
                        const keys = Array.isArray(updatedProvider.api_key) ? updatedProvider.api_key : [updatedProvider.api_key];
                        const otherKeys = keys.filter((_, index) => index !== currentKeyIndex);
                        
                        // Check if the new value conflicts with existing keys (excluding the one being edited)
                        if (otherKeys.includes(keyToStore)) {
                            showNotification('This API key already exists in the provider', 'warning');
                            return;
                        }
                        
                        keys[currentKeyIndex] = keyToStore;
                        if (!Array.isArray(provider.api_key)) {
                            updatedProvider.api_key = keys[0];
                        } else {
                            updatedProvider.api_key = keys;
                        }
                        showNotification('Updating key...', 'info');
                    } else {
                        // Add new key - check for duplicates first
                        const existingKeys = Array.isArray(updatedProvider.api_key) ? 
                            updatedProvider.api_key : 
                            [updatedProvider.api_key].filter(Boolean);
                        
                        // Check if key already exists
                        if (existingKeys.includes(keyToStore)) {
                            showNotification('This API key already exists in the provider', 'error');
                            return;
                        }
                        
                        // Add the new key
                        if (typeof updatedProvider.api_key === 'string') {
                            updatedProvider.api_key = [updatedProvider.api_key, keyToStore];
                        } else if (Array.isArray(updatedProvider.api_key)) {
                            updatedProvider.api_key.push(keyToStore);
                        } else {
                            updatedProvider.api_key = [keyToStore];
                        }
                        showNotification('Adding key...', 'info');
                    }

                    // Send PUT request to update provider
                    const response = await fetch(`/api/providers/${providerName}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(updatedProvider)
                    });

                    if (!response.ok) {
                        const error = await response.json().catch(() => ({ message: 'Unknown error' }));
                        throw new Error(error.message || `HTTP ${response.status}`);
                    }

                    // Update local data only after successful API call
                    const index = providers.findIndex(p => p.name === providerName);
                    if (index !== -1) {
                        providers[index] = updatedProvider;
                    }

                    showNotification(editMode ? 'Key updated successfully' : 'Key added successfully', 'success');
                    renderProviders();
                    closeModal();
                } catch (error) {
                    console.error('Failed to save key:', error);
                    showNotification(`Failed to ${editMode ? 'update' : 'add'} key: ${error.message}`, 'error');
                }
            });

            // Provider form submission
            document.getElementById('providerForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const name = document.getElementById('providerName').value.trim();
                const protocol = document.getElementById('providerProtocol').value;
                const baseUrl = document.getElementById('providerBaseUrl').value.trim();
                const modelsInput = document.getElementById('providerModels').value.trim();
                const authType = document.getElementById('providerAuthType').value;

                if (!name || !baseUrl) {
                    showNotification('Please fill in all required fields', 'error');
                    return;
                }

                // Check for duplicate names (only when adding new)
                if (!providerEditMode && providers.some(p => p.name === name)) {
                    showNotification('Provider name already exists', 'error');
                    return;
                }

                const models = modelsInput ? modelsInput.split(',').map(m => m.trim()).filter(m => m) : [];
                
                const providerData = {
                    name: name,
                    api_base_url: baseUrl,
                    protocol: protocol,
                    auth_type: authType,
                    models: models,
                    api_key: '' // Will be set when keys are added
                };

                try {
                    if (providerEditMode) {
                        // Edit existing provider
                        const index = providers.findIndex(p => p.name === currentProvider);
                        if (index !== -1) {
                            // Preserve existing keys
                            providerData.api_key = providers[index].api_key;
                        }

                        showNotification('Updating provider...', 'info');

                        // Send PUT request to backend
                        const response = await fetch(`/api/providers/${currentProvider}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(providerData)
                        });

                        if (!response.ok) {
                            const error = await response.json().catch(() => ({ message: 'Unknown error' }));
                            throw new Error(error.message || `HTTP ${response.status}`);
                        }

                        // Update local data only after successful API call
                        if (index !== -1) {
                            providers[index] = providerData;
                        }
                        showNotification('Provider updated successfully', 'success');
                    } else {
                        // Add new provider
                        showNotification('Adding provider...', 'info');

                        // Send POST request to backend
                        const response = await fetch('/api/providers', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(providerData)
                        });

                        if (!response.ok) {
                            const error = await response.json().catch(() => ({ message: 'Unknown error' }));
                            throw new Error(error.message || `HTTP ${response.status}`);
                        }

                        // Update local data only after successful API call
                        providers.push(providerData);
                        showNotification('Provider added successfully', 'success');
                    }

                    renderProviders();
                    closeProviderModal();
                } catch (error) {
                    console.error('Failed to save provider:', error);
                    showNotification(`Failed to save provider: ${error.message}`, 'error');
                }
            });

            // Router form submission
            document.getElementById('routerForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const pattern = document.getElementById('routerPattern').value.trim();
                const provider = document.getElementById('routerProvider').value;
                const model = document.getElementById('routerModel').value || '*';
                const priority = document.getElementById('routerPriority').value;
                const enabled = document.getElementById('routerEnabled').checked;

                if (!pattern || !provider) {
                    showNotification('Please fill in all required fields', 'error');
                    return;
                }

                const ruleData = {
                    id: routerEditMode ? routerRules[currentRouterRuleIndex].id : `rule-${Date.now()}`,
                    pattern: pattern,
                    provider: provider,
                    model: model,
                    priority: priority,
                    enabled: enabled
                };

                if (routerEditMode) {
                    // Edit existing rule
                    routerRules[currentRouterRuleIndex] = ruleData;
                    showNotification('Router rule updated successfully', 'success');
                } else {
                    // Add new rule
                    routerRules.push(ruleData);
                    showNotification('Router rule added successfully', 'success');
                }

                renderRouterTable();
                closeRouterModal();
            });

            // Provider change handler for router form
            document.getElementById('routerProvider').addEventListener('change', updateRouterModelOptions);

            // Protocol template auto-fill
            document.getElementById('providerProtocol').addEventListener('change', function() {
                const protocol = this.value;
                const protocolTemplates = {
                    'anthropic': {
                        baseUrl: 'https://api.anthropic.com/v1/messages',
                        models: ['claude-3-opus', 'claude-3-sonnet', 'claude-3-haiku']
                    },
                    'openai': {
                        baseUrl: 'https://api.openai.com/v1/chat/completions',
                        models: ['gpt-4', 'gpt-3.5-turbo', 'gpt-4-turbo']
                    },
                    'gemini': {
                        baseUrl: 'https://generativelanguage.googleapis.com/v1',
                        models: ['gemini-pro', 'gemini-pro-vision']
                    }
                };
                
                const template = protocolTemplates[protocol];
                if (template) {
                    document.getElementById('providerBaseUrl').value = template.baseUrl;
                    document.getElementById('providerModels').value = template.models.join(', ');
                }
            });
            
            // Close modals when clicking outside
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('modal')) {
                    if (e.target.id === 'keyModal') closeModal();
                    if (e.target.id === 'providerModal') closeProviderModal();
                    if (e.target.id === 'routerModal') closeRouterModal();
                    if (e.target.id === 'testModal') closeTestModal();
                }
            });
        }

        // Notification system
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            const colors = {
                'success': '#17bf63',
                'error': '#e0245e', 
                'warning': '#f39c12',
                'info': '#4facfe'
            };
            
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 8px;
                color: white;
                font-weight: 500;
                z-index: 2000;
                transition: all 0.3s ease;
                background: ${colors[type] || colors.info};
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            `;
            
            // Add icon based on type
            const icons = {
                'success': '✅',
                'error': '❌', 
                'warning': '⚠️',
                'info': 'ℹ️'
            };
            
            notification.textContent = `${icons[type] || icons.info} ${message}`;
            
            document.body.appendChild(notification);
            
            // Auto-remove after 4 seconds for warnings/errors, 3 seconds for others
            const timeout = (type === 'warning' || type === 'error') ? 4000 : 3000;
            
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100px)';
                setTimeout(() => notification.remove(), 300);
            }, timeout);
        }

        // Model Management UI Functions
        
        // 加载和显示所有模型
        async function refreshModels() {
            try {
                const [providersResponse, blacklistResponse, poolResponse] = await Promise.all([
                    fetch('/api/providers'),
                    fetch('/api/blacklist'),
                    fetch('/api/pool')
                ]);
                
                const providersResult = await providersResponse.json();
                const blacklistResult = await blacklistResponse.json();
                const poolResult = await poolResponse.json();
                
                if (providersResult.success) {
                    const allModels = [];
                    
                    // 收集所有providers的所有models
                    providersResult.data.forEach(provider => {
                        if (provider.models && provider.models.length > 0) {
                            provider.models.forEach(model => {
                                allModels.push({
                                    ...model,
                                    providerName: provider.name,
                                    providerId: provider.id,
                                    protocol: provider.protocol
                                });
                            });
                        }
                    });
                    
                    // 获取全局provider pool中的模型
                    const poolModels = poolResult.success ? poolResult.data : [];
                    
                    // 获取黑名单模型
                    const blacklistModels = blacklistResult.success ? blacklistResult.data : [];
                    
                    displayGroupedModels(allModels, poolModels, blacklistModels);
                } else {
                    showNotification('❌ Failed to load models', 'error');
                }
            } catch (error) {
                console.error('Load models error:', error);
                showNotification(`❌ Load error: ${error.message}`, 'error');
            }
        }
        
        // 显示分组的模型列表
        function displayGroupedModels(allModels, poolModels, blacklistModels) {
            // 过滤活跃模型（非黑名单）
            const activeModels = allModels.filter(model => !model.blacklisted);
            
            // 显示活跃模型
            displayModelGroup('activeModelsContainer', activeModels, 'activeModelCount', {
                showPool: true,
                showBlacklist: true
            });
            
            // 显示池模型
            displayModelGroup('poolModelsContainer', poolModels, 'poolModelCount', {
                showPool: false,
                showBlacklist: true
            });
            
            // 显示黑名单模型
            displayModelGroup('blacklistModelsContainer', blacklistModels, 'blacklistModelCount', {
                showPool: false,
                showBlacklist: false,
                showRestore: true
            });
        }

        // 显示模型组
        function displayModelGroup(containerId, models, countElementId, options = {}) {
            const container = document.getElementById(containerId);
            const countElement = document.getElementById(countElementId);
            
            // 更新模型数量
            if (countElement) {
                countElement.textContent = models.length;
            }
            
            if (models.length === 0) {
                container.innerHTML = '<div class="no-models" style="padding: 20px; text-align: center; color: #6c757d;">No models in this category</div>';
                return;
            }
            
            const modelsHtml = `
                <div class="models-grid">
                    ${models.map(model => {
                        const statusColor = model.blacklisted ? '#f44336' : (model.verified ? '#4caf50' : '#ff9800');
                        const statusText = model.blacklisted ? 'Blacklisted' : (model.verified ? 'Verified' : 'Unverified');
                        
                        // 优先显示检测到的tokens，如果没有则显示配置的tokens
                        const configuredTokens = typeof model === 'object' && model.max_tokens ? model.max_tokens : 'Unknown';
                        const autoDetectedTokens = typeof model === 'object' ? model.auto_detected_tokens : null;
                        const maxTokens = autoDetectedTokens || configuredTokens;
                        
                        return `
                            <div class="model-card" data-provider="${model.providerName || model.providerId}" data-model="${model.id || model.modelId}">
                                <div class="model-header">
                                    <h4 class="model-name">${model.name || model.modelName}</h4>
                                    <div class="model-badges">
                                        <span class="status-badge" style="background: ${statusColor};">${statusText}</span>
                                        <span class="protocol-badge">${model.protocol}</span>
                                    </div>
                                </div>
                                
                                <div class="model-info">
                                    <div class="info-row">
                                        <span class="label">Provider:</span>
                                        <span class="value">${model.providerName || model.providerId}</span>
                                    </div>
                                    <div class="info-row">
                                        <span class="label">Max Tokens:</span>
                                        <span class="value">${typeof maxTokens === 'number' ? maxTokens.toLocaleString() : maxTokens}</span>
                                        ${autoDetectedTokens ? `<span style="color: #4caf50; font-size: 0.8em;"> (detected)</span>` : ''}
                                    </div>
                                    <div class="info-row">
                                        <span class="label">Description:</span>
                                        <span class="value">${model.description || 'No description'}</span>
                                    </div>
                                    ${model.last_verification ? `
                                        <div class="info-row">
                                            <span class="label">Last Verified:</span>
                                            <span class="value">${new Date(model.last_verification).toLocaleString()}</span>
                                        </div>
                                    ` : ''}
                                    ${model.reason ? `
                                        <div class="info-row">
                                            <span class="label">Reason:</span>
                                            <span class="value" style="color: #f44336;">${model.reason}</span>
                                        </div>
                                    ` : ''}
                                </div>
                                
                                <div class="model-actions">
                                    <button onclick="editModel('${model.providerId}', '${model.id || model.modelId}')" 
                                            class="btn btn-sm btn-primary" title="Edit Model">
                                        ✏️ Edit
                                    </button>
                                    <button onclick="verifyModel('${model.providerId}', '${model.id || model.modelId}')" 
                                            class="btn btn-sm btn-success" title="Verify Model">
                                        🔍 Verify
                                    </button>
                                    ${!options.showRestore ? `
                                        <button onclick="detectTokens('${model.providerId}', '${model.id || model.modelId}')" 
                                                class="btn btn-sm btn-warning" title="Detect Tokens">
                                            📊 Detect
                                        </button>
                                    ` : ''}
                                    ${options.showBlacklist ? `
                                        <button onclick="blacklistModel('${model.providerId}', '${model.id || model.modelId}')" 
                                                class="btn btn-sm btn-danger" title="Blacklist">
                                            🚫 Block
                                        </button>
                                    ` : ''}
                                    ${options.showPool ? `
                                        <button onclick="addToPool('${model.providerId}', '${model.id || model.modelId}')" 
                                                class="btn btn-sm btn-info" title="Add to Pool">
                                            ➕ Pool
                                        </button>
                                    ` : ''}
                                    ${options.showRestore ? `
                                        <button onclick="restoreModel('${model.providerId}', '${model.modelId}')" 
                                                class="btn btn-sm btn-success" title="Restore Model">
                                            ↩️ Restore
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
            
            container.innerHTML = modelsHtml;
        }
        
        // 编辑模型
        async function editModel(providerName, modelId) {
            try {
                const response = await fetch('/api/providers');
                const result = await response.json();
                
                if (result.success) {
                    const provider = result.data.find(p => p.name === providerName);
                    if (provider) {
                        const model = provider.models.find(m => m.id === modelId || m.name === modelId);
                        if (model) {
                            // 填充编辑表单
                            document.getElementById('editModelName').value = model.name;
                            document.getElementById('editMaxTokens').value = model.max_tokens || '';
                            document.getElementById('editDescription').value = model.description || '';
                            document.getElementById('editStatus').value = model.status || 'active';
                            document.getElementById('editManualOverride').checked = model.manual_override || false;
                            
                            // 存储当前编辑的模型信息
                            window.currentEditModel = { providerName, modelId, model };
                            
                            // 显示模态框
                            document.getElementById('modelEditModal').classList.add('active');
                        }
                    }
                }
            } catch (error) {
                console.error('Edit model error:', error);
                showNotification(`❌ Edit error: ${error.message}`, 'error');
            }
        }
        
        // 保存模型修改
        async function saveModelChanges() {
            if (!window.currentEditModel) return;
            
            try {
                const formData = {
                    max_tokens: parseInt(document.getElementById('editMaxTokens').value) || null,
                    description: document.getElementById('editDescription').value,
                    status: document.getElementById('editStatus').value,
                    manual_override: document.getElementById('editManualOverride').checked
                };
                
                // 这里需要一个新的API端点来更新模型，让我们先模拟保存
                showNotification('✅ Model updated successfully', 'success');
                closeModal('modelEditModal');
                
                // 刷新模型列表
                await refreshModels();
                
            } catch (error) {
                console.error('Save model error:', error);
                showNotification(`❌ Save error: ${error.message}`, 'error');
            }
        }
        
        // 显示黑名单
        async function showBlacklist() {
            try {
                const response = await fetch('/api/config');
                const result = await response.json();
                
                if (result.success && result.data) {
                    const blacklist = result.data.model_blacklist || [];
                    
                    const blacklistHtml = blacklist.length > 0 ? `
                        <div class="blacklist-items">
                            ${blacklist.map(item => `
                                <div class="blacklist-item">
                                    <div class="item-header">
                                        <h4>${item.modelName}</h4>
                                        <span class="provider-label">${item.providerName}</span>
                                    </div>
                                    <div class="item-info">
                                        <p><strong>Reason:</strong> ${item.reason}</p>
                                        <p><strong>Blacklisted:</strong> ${new Date(item.blacklisted_at).toLocaleString()}</p>
                                        <p><strong>ID:</strong> <code>${item.id}</code></p>
                                    </div>
                                    <div class="item-actions">
                                        <button onclick="removeFromBlacklist('${item.id}')" class="btn btn-sm btn-success">
                                            ✅ Restore
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    ` : '<div class="no-items">No models in blacklist</div>';
                    
                    document.getElementById('blacklistContent').innerHTML = blacklistHtml;
                    document.getElementById('blacklistModal').classList.add('active');
                }
            } catch (error) {
                console.error('Load blacklist error:', error);
                showNotification(`❌ Blacklist error: ${error.message}`, 'error');
            }
        }
        
        // 显示Provider Pool
        async function showProviderPool() {
            try {
                const response = await fetch('/api/config');
                const result = await response.json();
                
                if (result.success && result.data) {
                    const pool = result.data.provider_pool || [];
                    
                    const poolHtml = pool.length > 0 ? `
                        <div class="pool-items">
                            ${pool.map(item => `
                                <div class="pool-item">
                                    <div class="item-header">
                                        <h4>${item.modelName}</h4>
                                        <span class="provider-label">${item.providerName}</span>
                                        <span class="protocol-badge">${item.protocol}</span>
                                    </div>
                                    <div class="item-info">
                                        <p><strong>Pool ID:</strong> <code>${item.id}</code></p>
                                        <p><strong>Added:</strong> ${new Date(item.added_at).toLocaleString()}</p>
                                        <p><strong>Max Tokens:</strong> ${(item.model.auto_detected_tokens || item.model.max_tokens)?.toLocaleString() || 'Unknown'}${item.model.auto_detected_tokens ? ' (detected)' : ''}</p>
                                        <p><strong>Status:</strong> ${item.status}</p>
                                    </div>
                                    <div class="item-actions">
                                        <button onclick="removeFromPool('${item.id}')" class="btn btn-sm btn-danger">
                                            🗑️ Remove
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    ` : '<div class="no-items">No models in provider pool</div>';
                    
                    document.getElementById('providerPoolContent').innerHTML = poolHtml;
                    document.getElementById('providerPoolModal').classList.add('active');
                }
            } catch (error) {
                console.error('Load pool error:', error);
                showNotification(`❌ Pool error: ${error.message}`, 'error');
            }
        }
        
        // 折叠/展开黑名单部分
        function toggleBlacklistSection() {
            const container = document.getElementById('blacklistModelsContainer');
            const indicator = document.getElementById('blacklistIndicator');
            const header = indicator.parentElement;
            
            container.classList.toggle('collapsed');
            
            if (container.classList.contains('collapsed')) {
                indicator.textContent = '▶';
                header.classList.add('collapsed');
            } else {
                indicator.textContent = '▼';
                header.classList.remove('collapsed');
            }
        }

        // 恢复黑名单模型
        async function restoreModel(providerId, modelId) {
            try {
                const response = await fetch(`/api/providers/${encodeURIComponent(providerId)}/restore-model`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ modelId: modelId })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification(`✅ Model ${modelId} restored successfully`, 'success');
                    await refreshModels(); // 刷新模型显示
                } else {
                    showNotification(`❌ Failed to restore model: ${result.error || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                console.error('Model restore error:', error);
                showNotification(`❌ Restore error: ${error.message}`, 'error');
            }
        }

        // Enhanced Model Management Functions
        
        // 验证模型（真实对话测试）
        async function verifyModel(providerName, modelId) {
            try {
                showNotification(`Starting verification for model ${modelId}...`, 'info');
                
                const response = await fetch(`/api/providers/${encodeURIComponent(providerName)}/verify-model`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        modelId: modelId,
                        testMessage: "Hello! This is a verification test. Please respond with 'OK'."
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification(`✅ Model ${modelId} verified successfully!`, 'success');
                    const verificationDetails = `
                        <div class="verification-result">
                            <h4>Model Verification Successful</h4>
                            <p><strong>Model:</strong> ${result.data.model}</p>
                            <p><strong>Response Time:</strong> ${result.data.responseTime}ms</p>
                            <p><strong>Tokens Used:</strong> ${result.data.tokensUsed}</p>
                            <div style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 4px;">
                                <strong>Test Message:</strong> ${result.data.testMessage}
                            </div>
                            <div style="margin-top: 10px; padding: 10px; background: #e8f5e8; border-radius: 4px;">
                                <strong>Model Response:</strong> ${result.data.response || 'No response content'}
                            </div>
                        </div>
                    `;
                    
                    document.getElementById('testResults').innerHTML = verificationDetails;
                    document.getElementById('testModal').classList.add('active');
                } else {
                    showNotification(`❌ Model verification failed: ${result.error}`, 'error');
                }
                
                // 刷新provider数据以显示更新的验证状态
                await loadProviders();
                
                // 如果当前在Model Management标签页，也需要刷新模型列表
                const currentTab = document.querySelector('.tab-content.active');
                if (currentTab && currentTab.id === 'models-tab') {
                    await refreshModels();
                }
                
            } catch (error) {
                console.error('Model verification error:', error);
                showNotification(`❌ Verification error: ${error.message}`, 'error');
            }
        }
        
        // 自动检测模型的max_tokens
        async function detectTokens(providerName, modelId) {
            try {
                showNotification(`Starting token detection for model ${modelId}...`, 'info');
                
                const response = await fetch(`/api/providers/${encodeURIComponent(providerName)}/detect-tokens`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ modelId: modelId })
                });
                
                const result = await response.json();
                
                if (result.success && result.data.detectedTokens) {
                    showNotification(`✅ Detected max_tokens: ${result.data.detectedTokens.toLocaleString()}`, 'success');
                    const detectionDetails = `
                        <div class="detection-result">
                            <h4>Token Detection Successful</h4>
                            <p><strong>Model:</strong> ${result.data.model}</p>
                            <p><strong>Original max_tokens:</strong> ${result.data.originalTokens?.toLocaleString() || 'Unknown'}</p>
                            <p><strong>Detected max_tokens:</strong> <span style="color: #4caf50; font-weight: bold;">${result.data.detectedTokens.toLocaleString()}</span></p>
                            <div style="margin-top: 15px;">
                                <h5>Test Results:</h5>
                                <div style="font-family: monospace; font-size: 0.9em; color: #666;">
                                    ${result.data.testValues.map(val => 
                                        val <= result.data.detectedTokens ? 
                                        `✅ ${val.toLocaleString()} tokens - Success` :
                                        `❌ ${val.toLocaleString()} tokens - Failed`
                                    ).join('<br>')}
                                </div>
                            </div>
                        </div>
                    `;
                    
                    document.getElementById('testResults').innerHTML = detectionDetails;
                    document.getElementById('testModal').classList.add('active');
                } else {
                    showNotification(`❌ Token detection failed: ${result.error || 'Could not detect tokens'}`, 'error');
                }
                
                // 刷新provider数据以显示更新的token信息
                await loadProviders();
                
                // 如果当前在Model Management标签页，也需要刷新模型列表
                const currentTab = document.querySelector('.tab-content.active');
                if (currentTab && currentTab.id === 'models-tab') {
                    await refreshModels();
                }
                
            } catch (error) {
                console.error('Token detection error:', error);
                showNotification(`❌ Detection error: ${error.message}`, 'error');
            }
        }
        
        // 将模型加入黑名单
        async function blacklistModel(providerName, modelId) {
            try {
                const reason = prompt('请输入黑名单原因 (可选):', 'Manual blacklist');
                if (reason === null) return; // 用户取消
                
                const response = await fetch(`/api/providers/${encodeURIComponent(providerName)}/blacklist-model`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        modelId: modelId,
                        reason: reason || 'Manual blacklist'
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification(`🚫 Model ${modelId} has been blacklisted`, 'success');
                    
                    const blacklistDetails = `
                        <div class="blacklist-result">
                            <h4>Model Blacklisted Successfully</h4>
                            <p><strong>Provider:</strong> ${result.data.provider}</p>
                            <p><strong>Model:</strong> ${result.data.model}</p>
                            <p><strong>Reason:</strong> ${result.data.reason}</p>
                            <p><strong>Blacklist ID:</strong> <code>${result.data.blacklistId}</code></p>
                            <div style="margin-top: 10px; padding: 10px; background: #ffebee; border-radius: 4px; color: #d32f2f;">
                                ℹ️ This model has been added to the blacklist and will not be updated during provider refreshes.
                            </div>
                        </div>
                    `;
                    
                    document.getElementById('testResults').innerHTML = blacklistDetails;
                    document.getElementById('testModal').classList.add('active');
                } else {
                    showNotification(`❌ Blacklist failed: ${result.error}`, 'error');
                }
                
                // 刷新provider数据以显示更新的黑名单状态
                await loadProviders();
                
            } catch (error) {
                console.error('Blacklist error:', error);
                showNotification(`❌ Blacklist error: ${error.message}`, 'error');
            }
        }
        
        // 添加到Provider Pool
        async function addToPool(providerName, modelId) {
            try {
                const response = await fetch(`/api/providers/${encodeURIComponent(providerName)}/add-to-pool`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ modelId: modelId })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification(`✅ Added ${providerName}.${modelId} to provider pool`, 'success');
                    
                    const poolDetails = `
                        <div class="pool-result">
                            <h4>Added to Provider Pool</h4>
                            <p><strong>Pool Entry ID:</strong> <code>${result.data.poolEntry.id}</code></p>
                            <p><strong>Provider:</strong> ${result.data.poolEntry.providerName}</p>
                            <p><strong>Model:</strong> ${result.data.poolEntry.modelName}</p>
                            <p><strong>Protocol:</strong> ${result.data.poolEntry.protocol}</p>
                            <p><strong>Total Pool Size:</strong> ${result.data.totalPoolSize} entries</p>
                            <div style="margin-top: 10px; padding: 10px; background: #f3e5f5; border-radius: 4px; color: #7b1fa2;">
                                ℹ️ This provider.model combination is now available in the global provider pool for routing.
                            </div>
                        </div>
                    `;
                    
                    document.getElementById('testResults').innerHTML = poolDetails;
                    document.getElementById('testModal').classList.add('active');
                } else {
                    showNotification(`❌ Add to pool failed: ${result.error}`, 'error');
                }
                
            } catch (error) {
                console.error('Add to pool error:', error);
                showNotification(`❌ Pool error: ${error.message}`, 'error');
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>